if (self.CavalryLogger) { CavalryLogger.start_js(["Ee5Vl"]); }

__d("MqttSkywalkerManager",["regeneratorRuntime","CurrentUser","FBMqttChannel","RTIFriendFanoutConfig","SkywalkerLogger","SkywalkerUtils","StreamStateMachine","gkx","promiseDone"],(function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){__p&&__p();var p="/pubsub",q={t:"pong"},r=function(){"use strict";__p&&__p();function a(a,b,c,d){this.$1=a,this.$2=b,this.$3=c,this.$4=d,this.$5=Date.now(),this.$8()}var b=a.prototype;b.unsubscribe=function(){return x.unsubscribe(this)};b.getViewId=function(){return this.$1};b.getTopic=function(){return this.$2};b.getMessageListener=function(){return this.$3};b.getSubscribeOptions=function(){return this.$4};b.getCreationTime=function(){return this.$5};b.getStreamStateMachine=function(){return this.$6};b.getFriendFanoutSubscription=function(){return this.$7};b.getContext=function(){return this.$4.context};b.setFriendFanoutSubscription=function(a){this.$7=a};b.$8=function(){if(!s())return;this.$6=new m(w(this.$4.context));this.$4.gqlsLifecycleHandler&&this.$6.setLifecycleHandler(this.$4.gqlsLifecycleHandler);this.$6.start()};return a}();a=function(){"use strict";__p&&__p();function a(){__p&&__p();var a=this;this.$1=new Map();this.$2=0;this.$3=new k({gateway:"mqtt"});this.$4=i;this.$5=this.$4.getConnectionState()==="Connected";this.$4.subscribeChannelEvents({onMQTTStateChanged:function(b){return a.$7(b)},onJSError:function(b){return a.$8(b)}});this.$4.subscribe(p,function(b){return a.$9(b)})}var b=a.prototype;b.subscribe=function(a,b,c){__p&&__p();c===void 0&&(c={});c.context=l.patchContext(c.context);var d=this.$10(a,b,c),e=a.substr(0,a.lastIndexOf("/"));if(j.passFriendFanoutSubscribeGK&&j.topicPrefixes.indexOf(e)>=0){e=u(a);a={context:c.context};c=this.$10(e,b,a);d.setFriendFanoutSubscription(c)}return d};b.unsubscribe=function(a){__p&&__p();var b,c;return g.async(function(d){__p&&__p();while(1)switch(d.prev=d.next){case 0:b=this.$11(a);c=a.getFriendFanoutSubscription();if(!(c!=null)){d.next=5;break}d.next=5;return g.awrap(this.$11(c));case 5:d.next=7;return g.awrap(b);case 7:return d.abrupt("return",d.sent);case 8:case"end":return d.stop()}},null,this)};b.isSubscribed=function(a){return this.$1.has(a.getViewId())};b.getSubscriptions=function(){return Array.from(this.$1.values())};b.setOnMqttError=function(a){this.$6=a};b.$9=function(a){__p&&__p();a=this.$12(a);if(a==null)return;var b=a.topic,c=a.view_id,d=this.$1.get(c);if(d==null){var e="No subscription exists for this topic, view ID "+c;for(var f=this.$1.values(),g=Array.isArray(f),h=0,f=g?f:f[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var i;if(g){if(h>=f.length)break;i=f[h++]}else{h=f.next();if(h.done)break;i=h.value}i=i;if(b===i.getTopic()){i=i.getViewId();e="Found subscription with view ID "+i+", payload has "+c;break}}this.$3.warn({event_name:"missing_subscription",topic:b,message:e});return}if(!t(b,d.getTopic())){i="View ID matches subscription of topic "+d.getTopic();this.$3.error({event_name:"topic_view_id_mismatch",topic:b,message:i});return}this.$3.log({event_name:"payload_received",topic:b});if(s()&&v(a)){this.$3.log({event_name:"heartbeat_received",topic:b});h=d.getStreamStateMachine();h&&h.ping();return}d.getMessageListener()(a)};b.$10=function(a,b,c){var d=++this.$2;a=new r(d,a,b,c);this.$1.set(d,a);this.$4.getConnectionState()==="Connected"&&o(this.$13(a));return a};b.$11=function(a){__p&&__p();var b=this,c,d,e,f,h;return g.async(function(i){__p&&__p();while(1)switch(i.prev=i.next){case 0:d=a.getTopic();e=a.getViewId();this.$3.log({event_name:"unsubscribe_attempt",topic:d});this.$1["delete"](e);f=a.getSubscribeOptions();f.onUnsubscribeEager&&f.onUnsubscribeEager();h={unsub:[d],viewId:(c={},c[d]=e,c)};i.next=9;return g.awrap(this.$14(h).then(function(){b.$3.log({event_name:"unsubscribe_success",topic:d});return{data:q,error:null}},function(a){var c="unsubscribe_failure";a=a.toString();b.$3.log({event_name:c,topic:d,message:a});return{data:null,error:a}}).then(function(b){f.onUnsubscribe&&f.onUnsubscribe(b);if(s()){b=a.getStreamStateMachine();b&&b.kill()}}));case 9:return i.abrupt("return",i.sent);case 10:case"end":return i.stop()}},null,this)};b.$13=function(a){__p&&__p();var b=this,c,d,e,f,h,i;return g.async(function(j){__p&&__p();while(1)switch(j.prev=j.next){case 0:d=a.getTopic();e=a.getViewId();f=a.getSubscribeOptions();h={sub:[d],viewId:(c={},c[d]=e,c)};f.context!=null&&(h.context=(i={},i[d]=f.context,i));this.$3.log({event_name:"subscribe_attempt",topic:d});j.next=8;return g.awrap(this.$14(h).then(function(){b.$3.log({event_name:"subscribe_success",topic:d});return{data:q,error:null}},function(a){var c="subscribe_failure";a=a.toString();b.$3.log({event_name:c,topic:d,message:a});return{data:null,error:a}}).then(function(a){return f.onSubscribe&&f.onSubscribe(a)}));case 8:return j.abrupt("return",j.sent);case 9:case"end":return j.stop()}},null,this)};b.$14=function(a){return g.async(function(b){while(1)switch(b.prev=b.next){case 0:b.next=2;return g.awrap(this.$4.publish(p,JSON.stringify(a)));case 2:return b.abrupt("return",b.sent);case 3:case"end":return b.stop()}},null,this)};b.$12=function(a){__p&&__p();try{a=JSON.parse(a);if(a.raw==null){this.$3.error({event_name:"payload_parse_error",message:"Missing Skywalker payload object"});return null}a=JSON.parse(a.raw);var b=["topic","payload","view_id"];for(var c=0;c<b.length;c++){var d=b[c];if(!Object.prototype.hasOwnProperty.call(a,d)){this.$3.error({event_name:"payload_parse_error",message:"Missing Skywalker "+d+" field in payload"});return null}}if(typeof a.topic!=="string"){this.$3.error({event_name:"payload_parse_error",message:"Topic has type "+typeof a.topic});return null}if(typeof a.view_id!=="number"){this.$3.error({event_name:"payload_parse_error",message:"Topic has type "+typeof a.view_id});return null}return a}catch(a){this.$3.error({event_name:"payload_parse_error",message:a.toString()});return null}};b.$7=function(a){__p&&__p();if(a!=="Connected")return;this.$5=!0;for(var a=this.$1,b=Array.isArray(a),c=0,a=b?a:a[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var d;if(b){if(c>=a.length)break;d=a[c++]}else{c=a.next();if(c.done)break;d=c.value}d=d;d[0];d=d[1];o(this.$13(d))}};b.$8=function(a){var b=a!=null?JSON.stringify(a):null,c=a!=null&&typeof a.isRecoverable==="boolean"?a.isRecoverable:!1;c?this.$3.log({event_name:"transport_recoverable_error",message:b}):this.$3.log({event_name:"transport_error",message:b});this.$5||(this.$3.log({event_name:"fallback_error",message:b}),this.$6&&this.$6(a))};return a}();function s(){return n("676931")}function t(a,b){return a===b||b===u(a)}function u(a){return a+"_user_id_"+h.getID()}function v(a){try{a=JSON.parse(a.payload);return a!=null&&a.heartbeat!=null}catch(a){return!1}}function w(a){if(a==null||a.transformContext==null)return!1;try{a=JSON.parse(a.transformContext);if(a.serializedQueryParameters==null)return!1;a=JSON.parse(a.serializedQueryParameters);return a!=null&&a["%options"]!=null&&a["%options"].heartbeat!=null}catch(a){return!1}}var x=new a();e.exports=x}),null);