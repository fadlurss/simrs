<% include ../partials/admin/header %>
<div id="page-wrapper">
    <div class="row">
        <div class="col-lg-12">
            <h1 class="page-header">Penjualan obat</h1>
            <br><br>
        </div>
        <!-- /.col-lg-12 -->
    </div>
    <div class="help-block">
        <a href="/penjualan/new" class="btn btn-info">Jual obat</a>
        <button type="button" class="btn btn-info btn-sm" id="jual_obat">Jual Obat</button>
    </div>
    <!-- /.row -->
    <div class="row">
        <div class="col-lg-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    Data penjualan obat
                </div>
                <!-- /.panel-heading -->
                <div class="panel-body table-responsive">
                    <table width="100%" class="table table-striped table-bordered table-hover js-serial" id="data_jual">
                        <thead>
                            <tr>
                                <th>No faktur</th>
                                <th>Total bayar</th>
                                <th>Status transaksi</th>
                                <th>Tgl transaksi keluar</th>
                            </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>

                </div>
                <!-- /.panel-body -->
            </div>
            <!-- /.panel -->
        </div>
        <!-- /.col-lg-12 -->
    </div>





</div>
<!-- /#page-wrapper -->

<!-- end looping -->
</div>
<% include ../partials/admin/footer %>
<script>
    var table = $('#data_jual').DataTable({
        lengthChange: false,
        ajax: "http://localhost:4000/penjualan/getdata",
        buttons: [{
                extend: 'copy',
                text: 'Copy'
            },
            {
                extend: 'excel',
                text: 'Export ke  Excel',
                filename: 'Data Yelpcamp', //BAGAIMANA BISA DINAMIS NAMA FILENYA
                title: 'Data Yelpcamp' //JUDUL DI EXCELNYA
            },
            {
                extend: 'pdf',
                text: 'Export ke Pdf',
                filename: 'Data Yelpcamp', //BAGAIMANA BISA DINAMIS NAMA FILENYA
                title: 'Data Yelpcamp' //JUDUL DI PDF NYA
            },
            'colvis'
        ]
    });
    table.buttons().container()
        .appendTo('#data_jual_wrapper .col-sm-6:eq(0)');
    $("#jual_obat").on("click", function () {
        var dialog = bootbox.dialog({
            title: 'Penjualan Obat',
            message: '<p align="center"><i class="fa fa-spin fa-spinner"></i> Loading...</p>'
        });

        dialog.init(function () {
            setTimeout(function () {
                form = [
                    [{
                        label: "No Faktur",
                        name: "no_faktur",
                        type: "text"
                    }]
                ];
                btn = {
                    name: "Simpan",
                    class: 'success',
                    type: "submit"
                };
                html = builder(form, btn, "save", true, 12);
                dialog.find(".bootbox-body").html("<div class='row'><div class='col-md-12'>" +
                    html + "</div></div>");
                dialog.find("#save").on("submit", function () {
                    dform = $(this).serializeArray();
                    console.log(dform);
                    ins = post("http://localhost:4000/penjualan/save", dform);
                    console.log(ins);
                    if (ins.status == 1) {
                        bootbox.hideAll();
                        toastr.success(ins.msg);
                        table.ajax.reload();
                        var dialog = bootbox.dialog({
                            title: 'Tambah Barang No Faktur - ' + ins.data.no_faktur,
                            message: '<p align="center"><i class="fa fa-spin fa-spinner"></i> Loading...</p>'
                        });

                        dialog.init(function () {
                            setTimeout(function () {
                                form = [
                                    [{
                                        label: "",
                                        name: "id_barang_keluar_transaksi",
                                        id: "id_barang_keluar_transaksi",
                                        value: ins.data._id,
                                        type: "hidden"
                                    },{
                                        label: "",
                                        name: "harga_modal",
                                        id: "harga_modal",
                                        type: "hidden"
                                    }, {
                                        label: "Nama Barang",
                                        type: "select2",
                                        id: "id_barang",
                                        name: "id_barang"
                                    }, {
                                        label: "Harga Jual",
                                        name: "harga_jual",
                                        id: "harga_jual",
                                        type: "readonly"
                                    }, {
                                        label: "Total Pembelian",
                                        type: "number",
                                        name: "total_keluar"
                                    }]
                                ];
                                btn = {
                                    name: "Simpan Barang",
                                    class: 'success',
                                    type: "submit"
                                };
                                html = builder(form, btn, "save", true,
                                    12);
                                build = [
                                    "<div class='row'>",
                                    "<div class='col-md-12'>",
                                    html,
                                    "</div>",
                                    "<div class='col-md-12 table-responsive'>",
                                    "<table class='table' id='tbl_list_barang'>",
                                    "<thead>",
                                    "<th>ID</th>",
                                    "<th>Nama Barang</th>",
                                    "<th>Harga</th>",
                                    "<th>Jumlah Beli</th>",
                                    "<th>Subtotal</th>",
                                    "</thead>",
                                    "<tbody>",
                                    "</tbody>",
                                    "</table>",
                                    "</div>",
                                    "<div class='col-md-12'>",
                                    "<div class='form-group'>",
                                    "<input class='form-control' disabled id='total_bayar'>",
                                    "</div>",
                                    "<div class='form-group'>",
                                    "<button class='btn btn-success' type='button' id='simpan_trx'>Simpan Transaksi</button>",
                                    "</div>",
                                    "</div>",
                                    "</div>",
                                ];
                                dialog.find(".bootbox-body").html(build
                                    .join(""));
                                select2builder(
                                    "http://localhost:4000/penjualan/getdatabarang",
                                    dialog.find("#id_barang"));
                                var total = 0;
                                dialog.find("#id_barang").on('change',function(event) {
                                  event.preventDefault();
                                  val = $(this).val();
                                  console.log(val);
                                  get = get("barangget/"+val);
                                  console.log(get);
                                  if (get.status == 1) {
                                    dialog.find("#harga_modal").val(get.harga_modal);
                                    dialog.find("#harga_jual").val(get.harga_jual);
                                    toastr.success("Data Ditemukan");
                                  }else {
                                    toastr.error("Data Tidak Ditemukan");
                                  }
                                });
                                tbl_list_barang = dialog.find("#tbl_list_barang").DataTable({
                                  ajax:"http://localhost:4000/penjualan/getdatabarangjoin/"+ins.data._id
                                });
                                dialog.find("#simpan_trx").on('click', function(event) {
                                  event.preventDefault();
                                  c = confirm("Apakah Anda Yakin ? ");
                                  if (c) {
                                    id = dialog.find("#id_barang_keluar_transaksi").val();
                                    ins = post("savetrx/"+id,{status_transaksi:"Sudah Bayar",total_bayar:dialog.find("#total_bayar").val()});
                                    if (ins.status == 1) {
                                      bootbox.hideAll();
                                      table.ajax.reload();
                                      toastr.success(ins.msg);
                                    }else {
                                      toastr.error(ins.msg);
                                    }
                                  }
                                });
                                dialog.find("#save").on(
                                    "submit",
                                    function () {
                                        dform = $(this).serializeArray();
                                        console.log(dform);
                                        ins = post(
                                            "http://localhost:4000/penjualan/savebrg",
                                            dform);
                                        console.log(ins);
                                        if (ins.status == 1) {
                                            tbl_list_barang.ajax.reload();
                                            total = total + (ins.data.harga_jual*ins.data.total_keluar);
                                            dialog.find("#total_bayar").val(total);
                                            toastr.success(
                                                ins.msg
                                            );
                                        } else {
                                            toastr.error(
                                                ins.msg
                                            );
                                        }
                                    });
                            }, 1000);
                        });

                    } else {
                        toastr.error(ins.msg);
                    }
                });
            }, 1000);
        });
    });
</script>
